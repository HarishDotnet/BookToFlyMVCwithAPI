@model List<BookToFlyMVC.DTO.FlightDetailsDTO>
@await Html.PartialAsync("~/Views/Admin/Header.cshtml")
<div class="container mt-5">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="@Url.Action("Index", "Admin")" class="btn btn-outline-primary">
            <i class="bi bi-box-arrow-in-left"></i> Back
        </a>
    </div>
    <h4 class="mb-4">Available Flights</h4>
    <table class="table table-bordered table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Flight Number</th>
                <th>Airline Name</th>
                <th>From</th>
                <th>To</th>
                <th>Departure Time</th>
                <th>Arrival Time</th>
                <th>Duration</th>
                <th>Available Seats</th>
                <th>Ticket Price</th>
                <th>Available Days</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var flight in Model)
                {
                    <tr>
                        <td>@flight.FlightId</td>
                        <td>@flight.AirlineName</td>
                        <td>@flight.Source</td>
                        <td>@flight.Destination</td>
                        <td>@flight.DepartureTime.ToString(@"hh\:mm")</td>
                        <td>@flight.ArrivalTime.ToString(@"hh\:mm")</td>
                        <td>@flight.Duration.ToString("0.0") hrs</td>
                        <td>@flight.AvailableSeats</td>
                        <td>@flight.TicketPrice.ToString("C")</td>
                        <td>@string.Join(", ", flight.AvailableDays)</td>
                        <td class="d-flex justify-content-start">
                            <a href="@Url.Action("BookTicket", "Flight", new { flightNumber = flight.FlightId })"
                                class="btn btn-success btn-sm me-2">
                                <i class="bi bi-bookmark-plus"></i> Book Ticket
                            </a>

                            <form asp-action="GetFlightnumber" asp-controller="Flight" method="GET" class="d-inline-block me-2">
                                <input type="hidden" name="FlightType"
                                    value="@(flight.FlightId.StartsWith("IF") ? "International" : "Domestic")" />
                                <input type="hidden" name="flightNumber" value="@flight.FlightId" />
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            </form>

                            <input type="hidden" name="FlightId" id="flightIdToDelete" />
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                data-bs-target="#deleteModal"
                                onclick="setFlightId('@flight.FlightId')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="12" class="text-danger text-center font-weight-bold">
                        No flights available at the moment.
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Flight</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this flight?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Flight deleted successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
function setFlightId(flightId) {
    document.getElementById('flightIdToDelete').value = flightId;
    console.log(flightId);
}

function confirmAction() {
    const flightId = document.getElementById('flightIdToDelete').value;
    if (flightId) {
        fetch(`http://localhost:5087/api/Flight/DeleteFlight/${flightId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || response.ok) {
                console.log('Flight deleted successfully');
                $('#deleteModal').modal('hide');
                location.reload(); // Refresh page
                
                // Show success toast
                const toast = new bootstrap.Toast(document.getElementById('successToast'));
                toast.show();
            } else {
                console.log('Failed to delete flight');
                alert("Failed to delete flight. Please try again.");
            }
        })
        .catch(error => {
            console.log('Error:', error);
            alert("An error occurred. Please try again.");
        });
    }
}
</script>
